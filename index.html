<!DOCTYPE html>

<html>
  <head>
    <title>Blog Maker</title>
    <link rel="stylesheet" href="./assets/bootstrap.min.css">
    <script src="./assets/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body class="m-1">
    <h1 class="mb-3 d-inline-block">Blog Maker</h1>

    <div class="mb-3 d-inline-block"><i id="alert" style="display: none;">(Previous Session Restored)</i></div>

    <div class="w-50 mb-3">
      <label for="import" class="btn btn-secondary">Import</label>
      <input type="file" name="import" id="import" accept="json" style="display: none;" class="form-control">
    </div>

    <div class="row m-1">
    <form id="blog-form" onsubmit="return false;" class="form col">
      <div class="mb-3">
        <label class="form-label fw-bold">Title</label>
        <input type="text" name="title" class="form-control w-50">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Banner Image File Link</label>
        <input type="text" name="banner-img,src" class="form-control w-50">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Banner Image Alt Text</label>
        <input type="text" name="banner-img,alt" class="form-control w-50">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Body</label>
        <textarea name="body" class="form-control w-75"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Export</button>
    </form>

    <div class="col border rounded border-black" id="blog-display">
      <h2 id="title-display"></h4>
      <img id="banner-img-display" src="" alt="">
      <h5 id="date-display"></h5>
      <div>
        <p id="body-display"></p>
      </div>
    </div>

    <script>
        const date = new Date().toLocaleString('default', {month: 'long', day: "numeric", year: "numeric"});
        $('#date-display').html(date);

        const getData = () => {
          const formData = new FormData($('#blog-form')[0]);

          if (formData.get('title') === '')
            return false;

          const data = {date: date};

          for (const [name, value] of formData.entries()) {
            data[name] = value;
          }

          return data;
        };

        const setData = (json) => {
          if (json === null)
            return;

          const data = JSON.parse(json);

          for (let [name, value] of Object.entries(data)) {
            const input = $(`[name='${name}']`);
            input.val(value);
            input.trigger('input');
          }
        }

        $('#blog-form input,textarea').on('input', (e) => {
          const input_name = e.target.name.split(',');
          const display_element = $(`#${input_name[0]}-display`);

          if (typeof input_name[1] === 'string')
            display_element.attr(input_name[1], e.target.value);
          else
            display_element.html(e.target.value);
        });

        $('#blog-form').on('submit', (e) => {
          const data = getData();
          const blob = new Blob([JSON.stringify(data)], {type: 'text/string'})
          const download = document.createElement('a');

          download.href = URL.createObjectURL(blob);
          download.download = data.title.replace(' ', '_').toLowerCase() + '.json';
          download.click();

          URL.revokeObjectURL(download.href);
        });

        $('#import').on('change', (e) => {
          if (e.target.files.length == 0) return;

          const file = e.target.files[0];
          const reader = new FileReader();

          reader.addEventListener('load', (e) => setData(e.target.result));
          reader.readAsText(file);
        });

        window.addEventListener('load', () => {
          setData(localStorage.getItem('previous-draft'));
          $('#alert').show();
          setTimeout(() => $('#alert').hide(), 3000);
        });

        window.addEventListener('beforeunload,reload', () => localStorage.setItem('previous-draft', JSON.stringify(getData())));
    </script>

  </body>
</html>