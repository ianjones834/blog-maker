<!DOCTYPE html>

<html>
  <head>
    <title>Blog Maker</title>
    <link rel="stylesheet" href="./assets/bootstrap.min.css">
    <script src="./assets/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body class="m-1">
    <h1>Blog Maker</h1>

    <div class="w-50">
      <label for="import" class="btn btn-secondary">Import</label>
      <input style="display: none;" class="form-control" type="file" id="import">
    </div>

    <div class="row m-1">
    <form id="blog-form" onsubmit="return false;" class="form col">
      <div class="mb-3">
        <label class="form-label fw-bold">Title</label>
        <input class="form-control w-50" id="title" type="text" value="">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Banner Image File Link</label>
        <input class="form-control w-50" id="banner-img" type="text" value="">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Body</label>
        <textarea class="form-control w-75"id="body"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Export</button>
    </form>

    <div class="col border rounded border-black" id="blog-display">
      <h2 id="title-display"></h4>
      <img id="banner-img-display" src="">
      <h5 id="date-display"></h5>
      <div>
        <p id="body-display"></p>
      </div>
    </div>

    <script>
        const date = new Date().toLocaleString('default', {month: 'long', day: "numeric", year: "numeric"});
        const input_ids = ['title', 'banner-img', 'body'];
        const refresh = () => $('#blog-display').trigger('refresh');

        $('input').val('');
        $('textarea').val('');
        $('#date-display').html(date);

        $('#blog-display').on('refresh', () => {
          for (let id of input_ids) {
            const display = $(`#${id}-display`);
            const input = $(`#${id}`).val()

            if (id === 'banner-img') {
              display.attr('src', input)
            }
            else {
              display.html(input);
            }
          }
        });

        $("#blog-form").on('submit', () => {
          const title = $('#title').val();
          if (title === '') return false;

          let data = {date: date};

          for (let id of input_ids) {
            data[id] = $(`#${id}`).val();
          }

          const json = JSON.stringify(data);

          const blob = new Blob([json], {type: 'text/string'});
          const file = URL.createObjectURL(blob);

          const download = document.createElement('a');
          download.href = file;
          download.download = title.replace(' ', '_').toLowerCase() + '.json';

          download.click();
          URL.revokeObjectURL(file);
        });

        $('#import').on('change', (e) => {
          if (e.target.files.length == 0) return;

          const file = e.target.files[0];
          const reader = new FileReader();

          reader.addEventListener('load', (e) => {
            const data = JSON.parse(e.target.result);

            for (let id of input_ids) {
              $(`#${id}`).val(data[id]);
            }

            refresh();
          });

          reader.readAsText(file);
        });

        $('#blog-form input,textarea').on('input', refresh);
    </script>

  </body>
</html>